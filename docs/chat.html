<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ£ãƒƒãƒˆå…¥åŠ› - ãƒ•ãƒ­ãƒ³ãƒˆã‚ªãƒ•ã‚£ã‚¹ç”Ÿç”£æ€§å‘ä¸Šã‚¢ãƒ—ãƒª v2.1</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container {
            height: calc(100vh - 120px);
        }
        .sidebar {
            width: 280px;
            min-width: 280px;
            transition: transform 0.3s ease;
        }
        .sidebar.hidden {
            transform: translateX(-100%);
        }
        .chat-main {
            flex: 1;
            min-width: 0;
        }
        .conversation-item {
            transition: background-color 0.2s ease, border-left 0.2s ease;
            cursor: pointer;
        }
        .conversation-item:hover {
            background-color: #f3f4f6;
        }
        .conversation-item.active {
            background-color: #dbeafe;
            border-left: 3px solid #3b82f6;
        }
        .sidebar-toggle {
            position: fixed;
            top: 120px;
            left: 10px;
            z-index: 1000;
            transition: left 0.3s ease;
        }
        .sidebar-toggle.sidebar-open {
            left: 290px;
        }
        .message {
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 999;
                background: white;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            .sidebar-toggle.sidebar-open {
                left: 10px;
            }
        }
        .send-button:hover {
            transform: scale(1.05);
        }
        .send-button {
            transition: all 0.2s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
    <button id="sidebarToggle" class="sidebar-toggle bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full shadow-lg">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <div class="flex h-screen bg-gray-50">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div id="sidebar" class="sidebar bg-white border-r border-gray-200 flex flex-col">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800">ãƒãƒ£ãƒƒãƒˆå±¥æ­´</h2>
                    <button id="newChatBtn" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">éå»ã®ä¼šè©±ã‹ã‚‰é¸æŠ</p>
            </div>

            <!-- ä¼šè©±ãƒªã‚¹ãƒˆ -->
            <div id="conversationList" class="flex-1 overflow-y-auto p-2">
                <!-- ä¼šè©±ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </div>

            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <div class="p-4 border-t border-gray-200">
                <div class="space-y-2">
                    <button onclick="exportAllConversations()" class="w-full bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        ğŸ“Š å…¨å±¥æ­´ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button onclick="clearAllConversations()" class="w-full bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        ğŸ—‘ï¸ å…¨å±¥æ­´å‰Šé™¤
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
        <div class="chat-main flex flex-col">
            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <nav class="bg-white shadow-sm border-b">
                <div class="container mx-auto px-4 py-3">
                    <div class="flex items-center justify-between">
                        <h1 class="text-xl font-bold text-gray-800">ãƒ•ãƒ­ãƒ³ãƒˆã‚ªãƒ•ã‚£ã‚¹ç”Ÿç”£æ€§å‘ä¸Šã‚¢ãƒ—ãƒª</h1>
                        <div class="space-x-4">
                            <a href="index.html" class="text-blue-600 hover:text-blue-800 font-medium">é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                            <a href="plan.html" class="text-blue-600 hover:text-blue-800 font-medium">é–‹ç™ºè¨ˆç”»æ›¸</a>
                            <a href="chat.html" class="text-gray-800 font-medium border-b-2 border-blue-600">ãƒãƒ£ãƒƒãƒˆå…¥åŠ›</a>
                            <a href="data-search.html" class="text-blue-600 hover:text-blue-800 font-medium">ç¤¾å†…ãƒ‡ãƒ¼ã‚¿æ¤œç´¢</a>
                            <a href="ai-agent-research.html" class="text-blue-600 hover:text-blue-800 font-medium">AIèª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ</a>
                            <a href="feedback-dashboard.html" class="text-blue-600 hover:text-blue-800 font-medium">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</a>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="flex-1 flex flex-col">
                <!-- ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="p-4 border-b border-gray-200 bg-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 id="chatTitle" class="text-xl font-bold text-gray-800">æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</h1>
                            <p class="text-sm text-gray-500">å–¶æ¥­ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ¥­å‹™ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="sendFeedback()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                                ğŸ’¬ GitHubãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                            </button>
                            <a href="feedback-dashboard.html" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                                ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç®¡ç†
                            </a>
                        </div>
                    </div>
                </div>

                <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <p class="text-sm text-gray-600 mb-3">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹æ©Ÿèƒ½:</p>
                    <div class="flex flex-wrap gap-2 mb-3">
                    <button class="quick-action bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="æ–°è¦é¡§å®¢ã¸ã®ææ¡ˆæ›¸ã‚’ä½œæˆã—ãŸã„ã§ã™">
                        ğŸ“ ææ¡ˆæ›¸ä½œæˆ
                    </button>
                    <button class="quick-action bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="æ—¢å­˜é¡§å®¢ã®èª²é¡Œåˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™">
                        ğŸ“Š é¡§å®¢åˆ†æ
                    </button>
                    <button class="quick-action bg-orange-100 hover:bg-orange-200 text-orange-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="è¦‹ç©ã‚‚ã‚Šã‚’ä½œæˆã—ã¦ãã ã•ã„">
                        ğŸ’° è¦‹ç©ä½œæˆ
                    </button>
                    <button class="quick-action bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ«ã‚½ãƒŠã‚’ä½œæˆã—ãŸã„ã§ã™">
                        ğŸ‘¥ ãƒšãƒ«ã‚½ãƒŠä½œæˆ
                    </button>
                    <button class="quick-action bg-pink-100 hover:bg-pink-200 text-pink-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="ç«¶åˆåˆ†æã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„">
                        ğŸ¯ ç«¶åˆåˆ†æ
                    </button>
                    <button class="quick-action bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="é¡§å®¢æƒ…å ±ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ">
                        ğŸ“‹ é¡§å®¢æƒ…å ±ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                    </button>
                    </div>
                </div>

                <!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
                <div class="flex-1 flex flex-col bg-white">
                    <!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¨ãƒªã‚¢ -->
                    <div id="chatMessages" class="flex-1 p-6 overflow-y-auto space-y-4">
                <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div class="message flex items-start space-x-3">
                    <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                        AI
                    </div>
                    <div class="bg-blue-50 rounded-lg px-4 py-3 max-w-md">
                        <p class="text-gray-800">ã“ã‚“ã«ã¡ã¯ï¼ãƒ•ãƒ­ãƒ³ãƒˆã‚ªãƒ•ã‚£ã‚¹æ¥­å‹™ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚</p>
                        <p class="text-gray-800 mt-2">ä»¥ä¸‹ã®ã‚ˆã†ãªæ¥­å‹™ã‚’ãŠæ‰‹ä¼ã„ã§ãã¾ã™ï¼š</p>
                        <ul class="list-disc list-inside text-gray-700 mt-2 text-sm space-y-1">
                            <li>å–¶æ¥­ææ¡ˆã®ä½œæˆ</li>
                            <li>é¡§å®¢åˆ†æ</li>
                            <li>è¦‹ç©ã‚‚ã‚Šä½œæˆ</li>
                            <li>ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ç«‹æ¡ˆ</li>
                            <li>ãƒšãƒ«ã‚½ãƒŠä½œæˆãƒ»åˆ†æ</li>
                        </ul>
                        <p class="text-gray-800 mt-2">ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</p>
                    </div>
                </div>
                    </div>

                    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                    <div class="border-t bg-gray-50 p-4">
                <div class="flex items-end space-x-3">
                    <div class="flex-1">
                        <textarea 
                            id="messageInput" 
                            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„... (Enter: é€ä¿¡ / Shift+Enter: æ”¹è¡Œ)"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            rows="5"
                            maxlength="5000"
                        ></textarea>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-400">ğŸ’¡ Enter: é€ä¿¡ / Shift+Enter: æ”¹è¡Œ <span id="compositionStatus" class="text-red-500"></span></span>
                                <button onclick="saveDraft()" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-2 py-1 rounded text-xs transition-colors">
                                    ğŸ’¾ ä¸‹æ›¸ãä¿å­˜
                                </button>
                                <button onclick="loadDraft()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-xs transition-colors" id="loadDraftBtn" style="display: none;">
                                    ğŸ“„ ä¸‹æ›¸ãèª­è¾¼
                                </button>
                                <button onclick="clearDraft()" class="bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded text-xs transition-colors" id="clearDraftBtn" style="display: none;">
                                    ğŸ—‘ï¸ ä¸‹æ›¸ãå‰Šé™¤
                                </button>
                            </div>
                            <span><span id="charCount">0</span>/5000æ–‡å­—</span>
                        </div>
                    </div>
                    <button 
                        id="sendButton"
                        class="send-button bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
                        disabled
                    >
                        é€ä¿¡
                    </button>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

        <script>
            // ä¼šè©±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
            class ConversationManager {
                constructor() {
                    this.conversations = this.loadConversations();
                    this.currentConversationId = null;
                    this.isNewConversation = true;
                    this.initializeUI();
                }

                loadConversations() {
                    return JSON.parse(localStorage.getItem('conversations') || '[]');
                }

                saveConversations() {
                    localStorage.setItem('conversations', JSON.stringify(this.conversations));
                }

                createNewConversation(firstMessage = null) {
                    const conversation = {
                        id: Date.now().toString(),
                        title: firstMessage ? this.generateTitle(firstMessage) : 'æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ',
                        messages: [],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    this.conversations.unshift(conversation);
                    this.saveConversations();
                    this.currentConversationId = conversation.id;
                    this.isNewConversation = false;
                    
                    this.updateUI();
                    this.updateChatTitle(conversation.title);
                    
                    return conversation;
                }

                generateTitle(message) {
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰é©åˆ‡ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
                    const words = message.trim().split(/\s+/);
                    if (words.length <= 4) {
                        return message;
                    }
                    return words.slice(0, 4).join(' ') + '...';
                }

                addMessageToCurrentConversation(sender, content) {
                    if (this.isNewConversation && sender === 'user') {
                        this.createNewConversation(content);
                    }
                    
                    if (!this.currentConversationId) return;
                    
                    const conversation = this.conversations.find(c => c.id === this.currentConversationId);
                    if (conversation) {
                        conversation.messages.push({
                            id: Date.now().toString(),
                            sender: sender,
                            content: content,
                            timestamp: new Date().toISOString()
                        });
                        conversation.updatedAt = new Date().toISOString();
                        
                        // ã‚¿ã‚¤ãƒˆãƒ«ãŒã€Œæ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã€ã®å ´åˆã€æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
                        if (conversation.title === 'æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ' && sender === 'user') {
                            conversation.title = this.generateTitle(content);
                            this.updateChatTitle(conversation.title);
                        }
                        
                        this.saveConversations();
                        this.updateUI();
                    }
                }

                loadConversation(conversationId) {
                    const conversation = this.conversations.find(c => c.id === conversationId);
                    if (!conversation) return;
                    
                    this.currentConversationId = conversationId;
                    this.isNewConversation = false;
                    
                    // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’ã‚¯ãƒªã‚¢
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                    this.addInitialMessage();
                    
                    // ä¼šè©±ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾©å…ƒ
                    conversation.messages.forEach(msg => {
                        this.addMessageToUI(msg.sender, msg.content);
                    });
                    
                    this.updateChatTitle(conversation.title);
                    this.updateUI();
                    
                    // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                displayMessage(sender, content, save = true) {
                    // UIã«è¡¨ç¤º
                    this.addMessageToUI(sender, content);
                    
                    // ä¼šè©±ã«ä¿å­˜
                    if (save) {
                        this.addMessageToCurrentConversation(sender, content);
                    }
                }
                
                addMessageToUI(sender, content) {
                    const chatMessages = document.getElementById('chatMessages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message flex items-start space-x-3';
                    
                    if (sender === 'user') {
                        messageDiv.innerHTML = `
                            <div class="bg-gray-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                U
                            </div>
                            <div class="bg-gray-100 rounded-lg px-4 py-3 max-w-md">
                                <p class="text-gray-800 whitespace-pre-wrap">${content}</p>
                            </div>
                        `;
                    } else {
                        messageDiv.innerHTML = `
                            <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                AI
                            </div>
                            <div class="bg-blue-50 rounded-lg px-4 py-3 max-w-md">
                                <p class="text-gray-800 whitespace-pre-wrap">${content}</p>
                            </div>
                        `;
                    }
                    
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                addInitialMessage() {
                    const chatMessages = document.getElementById('chatMessages');
                    const initialMessage = document.createElement('div');
                    initialMessage.className = 'message flex items-start space-x-3';
                    initialMessage.innerHTML = `
                        <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                            AI
                        </div>
                        <div class="bg-blue-50 rounded-lg px-4 py-3 max-w-md">
                            <p class="text-gray-800">ã“ã‚“ã«ã¡ã¯ï¼ãƒ•ãƒ­ãƒ³ãƒˆã‚ªãƒ•ã‚£ã‚¹æ¥­å‹™ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚</p>
                            <p class="text-gray-800 mt-2">ä»¥ä¸‹ã®ã‚ˆã†ãªæ¥­å‹™ã‚’ãŠæ‰‹ä¼ã„ã§ãã¾ã™ï¼š</p>
                            <ul class="list-disc list-inside text-gray-700 mt-2 text-sm space-y-1">
                                <li>å–¶æ¥­ææ¡ˆã®ä½œæˆ</li>
                                <li>é¡§å®¢åˆ†æ</li>
                                <li>è¦‹ç©ã‚‚ã‚Šä½œæˆ</li>
                                <li>ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ç«‹æ¡ˆ</li>
                                <li>ãƒšãƒ«ã‚½ãƒŠä½œæˆãƒ»åˆ†æ</li>
                            </ul>
                            <p class="text-gray-800 mt-2">ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</p>
                        </div>
                    `;
                    chatMessages.appendChild(initialMessage);
                }

                startNewConversation() {
                    this.currentConversationId = null;
                    this.isNewConversation = true;
                    
                    // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’ã‚¯ãƒªã‚¢
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                    this.addInitialMessage();
                    
                    this.updateChatTitle('æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ');
                    this.updateUI();
                }

                deleteConversation(conversationId) {
                    this.conversations = this.conversations.filter(c => c.id !== conversationId);
                    this.saveConversations();
                    
                    if (this.currentConversationId === conversationId) {
                        this.startNewConversation();
                    }
                    
                    this.updateUI();
                }

                updateUI() {
                    const conversationList = document.getElementById('conversationList');
                    if (!conversationList) return;
                    
                    conversationList.innerHTML = '';
                    
                    if (this.conversations.length === 0) {
                        conversationList.innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <p class="text-sm">ã¾ã ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“</p>
                                <p class="text-xs mt-1">æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¦ã¿ã¦ãã ã•ã„</p>
                            </div>
                        `;
                        return;
                    }
                    
                    this.conversations.forEach(conversation => {
                        const item = document.createElement('div');
                        item.className = `conversation-item p-3 mb-2 rounded-lg cursor-pointer ${
                            conversation.id === this.currentConversationId ? 'active' : ''
                        }`;
                        
                        const lastMessage = conversation.messages[conversation.messages.length - 1];
                        const preview = lastMessage ? 
                            (lastMessage.content.length > 50 ? lastMessage.content.substring(0, 50) + '...' : lastMessage.content) : 
                            'ç©ºã®ä¼šè©±';
                        
                        item.innerHTML = `
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-sm font-medium text-gray-800 truncate">${conversation.title}</h4>
                                    <p class="text-xs text-gray-500 mt-1 truncate">${preview}</p>
                                    <p class="text-xs text-gray-400 mt-1">${this.formatDate(conversation.updatedAt)}</p>
                                </div>
                                <button onclick="conversationManager.deleteConversation('${conversation.id}')" 
                                        class="ml-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        `;
                        
                        item.addEventListener('click', (e) => {
                            if (e.target.closest('button')) return; // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
                            this.loadConversation(conversation.id);
                        });
                        
                        conversationList.appendChild(item);
                    });
                }

                formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
                    
                    if (diffInHours < 1) return 'ä»Š';
                    if (diffInHours < 24) return `${diffInHours}æ™‚é–“å‰`;
                    if (diffInHours < 168) return `${Math.floor(diffInHours / 24)}æ—¥å‰`;
                    return date.toLocaleDateString('ja-JP');
                }

                updateChatTitle(title) {
                    const chatTitle = document.getElementById('chatTitle');
                    if (chatTitle) {
                        chatTitle.textContent = title;
                    }
                }

                initializeUI() {
                    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«
                    const toggleBtn = document.getElementById('sidebarToggle');
                    const sidebar = document.getElementById('sidebar');
                    
                    if (toggleBtn && sidebar) {
                        toggleBtn.addEventListener('click', () => {
                            sidebar.classList.toggle('hidden');
                            toggleBtn.classList.toggle('sidebar-open');
                        });
                    }
                    
                    // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³
                    const newChatBtn = document.getElementById('newChatBtn');
                    if (newChatBtn) {
                        newChatBtn.addEventListener('click', () => {
                            this.startNewConversation();
                        });
                    }
                    
                    this.updateUI();
                }

                // æ—¢å­˜ã®å±¥æ­´ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                migrateOldHistory() {
                    const oldHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                    if (oldHistory.length > 0 && this.conversations.length === 0) {
                        const conversation = {
                            id: 'migrated-' + Date.now(),
                            title: 'ä»¥å‰ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´',
                            messages: oldHistory.map(msg => ({
                                id: Date.now().toString() + Math.random(),
                                sender: msg.sender === 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' ? 'user' : 'ai',
                                content: msg.content,
                                timestamp: msg.timestamp || new Date().toISOString()
                            })),
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        this.conversations.push(conversation);
                        this.saveConversations();
                        
                        // å¤ã„å±¥æ­´ã‚’å‰Šé™¤
                        localStorage.removeItem('chatHistory');
                    }
                }
            }

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦åˆæœŸåŒ–
            let conversationManager;

            // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–¢æ•°ã‚’æ›´æ–°
            function exportAllConversations() {
                const conversations = conversationManager.conversations;
                if (conversations.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                let csvContent = '\uFEFF'; // BOM for UTF-8
                csvContent += 'ä¼šè©±ID,ä¼šè©±ã‚¿ã‚¤ãƒˆãƒ«,æ—¥æ™‚,ç™ºä¿¡è€…,å†…å®¹\n';
                
                conversations.forEach(conv => {
                    conv.messages.forEach(msg => {
                        const csvRow = [
                            `"${conv.id}"`,
                            `"${conv.title}"`,
                            `"${msg.timestamp}"`,
                            `"${msg.sender === 'user' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' : 'AI'}"`,
                            `"${msg.content.replace(/"/g, '""').replace(/\n/g, ' ')}"`
                        ].join(',');
                        csvContent += csvRow + '\n';
                    });
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `all_conversations_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`å…¨ã¦ã®ä¼šè©±å±¥æ­´ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ\nä¼šè©±æ•°: ${conversations.length}ä»¶`);
            }

            function clearAllConversations() {
                const conversations = conversationManager.conversations;
                if (conversations.length === 0) {
                    alert('å‰Šé™¤ã™ã‚‹ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                if (confirm(`å…¨ã¦ã®ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nä¼šè©±æ•°: ${conversations.length}ä»¶\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                    conversationManager.conversations = [];
                    conversationManager.saveConversations();
                    conversationManager.startNewConversation();
                    alert(`å…¨ã¦ã®ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ\nå‰Šé™¤æ•°: ${conversations.length}ä»¶`);
                }
            }

            function testDifyConnection() {
                console.log('=== Difyæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
                console.log('DIFY_CONFIG:', typeof DIFY_CONFIG !== 'undefined' ? DIFY_CONFIG : 'æœªå®šç¾©');
                console.log('window.difyChat:', typeof window.difyChat !== 'undefined' ? 'ã‚ã‚Š' : 'æœªå®šç¾©');
                
                if (typeof window.difyChat !== 'undefined') {
                    window.difyChat.client.sendMessage('ãƒ†ã‚¹ãƒˆ').then(response => {
                        console.log('âœ… APIæ¥ç¶šæˆåŠŸ:', response);
                        alert('APIæ¥ç¶šæˆåŠŸï¼');
                    }).catch(error => {
                        console.error('âŒ APIæ¥ç¶šå¤±æ•—:', error);
                        alert('APIæ¥ç¶šå¤±æ•—: ' + error.message);
                    });
                } else {
                    alert('Dify ChatãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            }

            function sendFeedback() {
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                const feedbackModal = createFeedbackModal();
                document.body.appendChild(feedbackModal);
            }

            function createFeedbackModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ã‚«ãƒ†ã‚´ãƒª</label>
                            <select id="feedbackCategory" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ...</option>
                                <option value="ui">ç”»é¢ãƒ»æ“ä½œæ€§</option>
                                <option value="feature">æ–°æ©Ÿèƒ½è¦æœ›</option>
                                <option value="bug">ä¸å…·åˆå ±å‘Š</option>
                                <option value="search">æ¤œç´¢æ©Ÿèƒ½</option>
                                <option value="chat">ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½</option>
                                <option value="other">ãã®ä»–</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹</label>
                            <textarea id="feedbackContent" rows="4" class="w-full px-3 py-2 border rounded-lg" placeholder="å…·ä½“çš„ãªå†…å®¹ã‚’ãŠèã‹ã›ãã ã•ã„..."></textarea>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="submitFeedback()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                                é€ä¿¡
                            </button>
                            <button onclick="closeFeedbackModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-500">
                            ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ç®¡ç†ç”»é¢ã§ç¢ºèªã§ãã¾ã™ã€‚GitHubã®èª²é¡Œã¨ã—ã¦ã‚‚ä½œæˆã•ã‚Œã¾ã™ã€‚
                        </div>
                    </div>
                `;
                return modal;
            }

            function submitFeedback() {
                const category = document.getElementById('feedbackCategory').value;
                const content = document.getElementById('feedbackContent').value.trim();
                
                if (!category || !content) {
                    alert('ã‚«ãƒ†ã‚´ãƒªã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
                if (typeof feedbackSystem !== 'undefined') {
                    feedbackSystem.submitImprovement(category, content, 'chat');
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    alert('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\n\nç®¡ç†ç”»é¢ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰ã§ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼');
                    
                    // GitHubã«ã‚‚é€ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    openGitHubIssue(category, content);
                } else {
                    alert('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚');
                }
                
                closeFeedbackModal();
            }

            function openGitHubIssue(category, content) {
                const categoryLabels = {
                    'ui': 'ç”»é¢ãƒ»æ“ä½œæ€§',
                    'feature': 'æ–°æ©Ÿèƒ½è¦æœ›', 
                    'bug': 'ä¸å…·åˆå ±å‘Š',
                    'search': 'æ¤œç´¢æ©Ÿèƒ½',
                    'chat': 'ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½',
                    'other': 'ãã®ä»–'
                };
                
                const title = `[${categoryLabels[category]}] ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯`;
                const body = `## ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹\n\n${content}\n\n## é€ä¿¡æƒ…å ±\n- ãƒšãƒ¼ã‚¸: ãƒãƒ£ãƒƒãƒˆç”»é¢\n- æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}\n- ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent}`;
                
                const githubUrl = `https://github.com/horiken1977/frontoffice/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;
                window.open(githubUrl, '_blank');
            }

            function closeFeedbackModal() {
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) {
                    modal.remove();
                }
            }

            // ä¸‹æ›¸ãä¿å­˜æ©Ÿèƒ½
            function saveDraft() {
                const messageInput = document.getElementById('messageInput');
                const content = messageInput.value.trim();
                
                if (content.length === 0) {
                    alert('ä¿å­˜ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                const timestamp = new Date().toLocaleString('ja-JP');
                const draftData = {
                    content: content,
                    timestamp: timestamp,
                    charCount: content.length
                };
                
                localStorage.setItem('chatDraft', JSON.stringify(draftData));
                
                // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
                updateDraftButtons();
                
                // ä¿å­˜å®Œäº†ã®é€šçŸ¥
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'âœ… ä¿å­˜å®Œäº†';
                button.style.backgroundColor = '#dcfce7';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = '';
                }, 2000);
            }

            // ä¸‹æ›¸ãèª­ã¿è¾¼ã¿æ©Ÿèƒ½
            function loadDraft() {
                const draftData = JSON.parse(localStorage.getItem('chatDraft'));
                if (!draftData) {
                    alert('ä¿å­˜ã•ã‚ŒãŸä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const messageInput = document.getElementById('messageInput');
                const confirmMessage = `ä¸‹æ›¸ãã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\n\nä¿å­˜æ—¥æ™‚: ${draftData.timestamp}\næ–‡å­—æ•°: ${draftData.charCount}æ–‡å­—\n\nç¾åœ¨ã®å…¥åŠ›å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`;
                
                if (confirm(confirmMessage)) {
                    messageInput.value = draftData.content;
                    messageInput.dispatchEvent(new Event('input'));
                    messageInput.focus();
                    
                    // èª­ã¿è¾¼ã¿å®Œäº†ã®é€šçŸ¥
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'âœ… èª­è¾¼å®Œäº†';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                }
            }

            // ä¸‹æ›¸ãå‰Šé™¤æ©Ÿèƒ½
            function clearDraft() {
                const draftData = JSON.parse(localStorage.getItem('chatDraft'));
                if (!draftData) {
                    alert('å‰Šé™¤ã™ã‚‹ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                if (confirm(`ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nä¿å­˜æ—¥æ™‚: ${draftData.timestamp}\næ–‡å­—æ•°: ${draftData.charCount}æ–‡å­—\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                    localStorage.removeItem('chatDraft');
                    updateDraftButtons();
                    
                    // å‰Šé™¤å®Œäº†ã®é€šçŸ¥
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'âœ… å‰Šé™¤å®Œäº†';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        updateDraftButtons();
                    }, 2000);
                }
            }

            // ä¸‹æ›¸ããƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
            function updateDraftButtons() {
                const loadBtn = document.getElementById('loadDraftBtn');
                const clearBtn = document.getElementById('clearDraftBtn');
                const hasDraft = localStorage.getItem('chatDraft') !== null;
                
                loadBtn.style.display = hasDraft ? 'inline-block' : 'none';
                clearBtn.style.display = hasDraft ? 'inline-block' : 'none';
            }

            // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ï¼ˆ1åˆ†ã”ã¨ï¼‰
            function setupAutoSave() {
                const messageInput = document.getElementById('messageInput');
                let autoSaveInterval;

                messageInput.addEventListener('input', () => {
                    // æ—¢å­˜ã®è‡ªå‹•ä¿å­˜ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
                    clearTimeout(autoSaveInterval);
                    
                    // å…¥åŠ›ãŒæ­¢ã¾ã£ã¦30ç§’å¾Œã«è‡ªå‹•ä¿å­˜
                    autoSaveInterval = setTimeout(() => {
                        const content = messageInput.value.trim();
                        if (content.length > 50) { // 50æ–‡å­—ä»¥ä¸Šã®å ´åˆã®ã¿è‡ªå‹•ä¿å­˜
                            const timestamp = new Date().toLocaleString('ja-JP');
                            const draftData = {
                                content: content,
                                timestamp: timestamp + ' (è‡ªå‹•ä¿å­˜)',
                                charCount: content.length
                            };
                            localStorage.setItem('chatDraft', JSON.stringify(draftData));
                            updateDraftButtons();
                            console.log('ğŸ“ è‡ªå‹•ä¿å­˜å®Œäº†');
                        }
                    }, 30000); // 30ç§’
                });
            }

            // æ—§å¼ã®å±¥æ­´ä¿å­˜æ©Ÿèƒ½ã¯ä¸è¦ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜ã«å¤‰æ›´æ¸ˆã¿ï¼‰

            function exportChatHistory() {
                const history = localStorage.getItem('chatHistory');
                if (!history) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const parsedHistory = JSON.parse(history);
                if (parsedHistory.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                let csvContent = '\uFEFF'; // BOM for UTF-8
                csvContent += 'æ—¥æ™‚,ç™ºä¿¡è€…,ãƒãƒ£ãƒƒãƒˆå†…å®¹\n';
                
                parsedHistory.forEach(item => {
                    const csvRow = [
                        `"${item.timestamp}"`,
                        `"${item.sender}"`,
                        `"${item.content.replace(/"/g, '""').replace(/\n/g, ' ')}"`
                    ].join(',');
                    csvContent += csvRow + '\n';
                });
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `chat_history_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ\nä»¶æ•°: ${parsedHistory.length}ä»¶`);
            }

            function clearChatHistory() {
                const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                const historyCount = history.length;
                
                if (historyCount === 0) {
                    alert('å‰Šé™¤ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                if (confirm(`ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nä»¶æ•°: ${historyCount}ä»¶\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                    localStorage.removeItem('chatHistory');
                    
                    // ç”»é¢ã‹ã‚‰ã‚‚å‰Šé™¤ï¼ˆåˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥å¤–ï¼‰
                    const chatMessages = document.getElementById('chatMessages');
                    const messages = chatMessages.querySelectorAll('.message');
                    
                    // æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆåˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ä»¥å¤–ã‚’å‰Šé™¤
                    for (let i = 1; i < messages.length; i++) {
                        messages[i].remove();
                    }
                    
                    alert(`ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ\nå‰Šé™¤ä»¶æ•°: ${historyCount}ä»¶`);
                }
            }

            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¸‹æ›¸ããƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            document.addEventListener('DOMContentLoaded', () => {
                updateDraftButtons();
                setupAutoSave();
            });
        </script>
    </div>

    <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="feedback-system.js"></script>
    <!-- Dify Knowledge Baseçµ±åˆ -->
    <script src="dify-knowledge-integration.js"></script>
    <!-- Dify APIçµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆï¼‰ -->
    <script>
        // Dify APIè¨­å®š
        const DIFY_CONFIG = {
            apiEndpoint: 'https://api.dify.ai/v1/chat-messages',
            apiKey: 'app-Fw2J7gNlmmzuCiQL4MhusG70',
            conversationId: null
        };

        // Difyã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¯ãƒ©ã‚¹
        class DifyClient {
            constructor(config) {
                this.config = config;
                this.conversationId = null;
            }

            async sendMessage(message, user = 'default-user') {
                try {
                    const response = await fetch(this.config.apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            inputs: {},
                            query: message,
                            response_mode: 'blocking',
                            conversation_id: this.conversationId,
                            user: user
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.conversation_id) {
                        this.conversationId = data.conversation_id;
                    }

                    return {
                        answer: data.answer,
                        conversationId: data.conversation_id,
                        messageId: data.message_id
                    };
                } catch (error) {
                    console.error('Dify API Error:', error);
                    return {
                        answer: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
                        error: true
                    };
                }
            }
        }

        // ãƒãƒ£ãƒƒãƒˆUIãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
        class ChatUIManager {
            constructor(difyClient) {
                this.difyClient = difyClient;
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.charCount = document.getElementById('charCount');
                this.quickActions = document.querySelectorAll('.quick-action');
                
                // Knowledge Baseæ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
                this.knowledgeSearch = null;
                this.initializeKnowledgeSearch();
                
                this.initializeEventListeners();
                this.loadChatHistory();
            }

            initializeKnowledgeSearch() {
                try {
                    if (typeof DifyKnowledgeSearch !== 'undefined') {
                        this.knowledgeSearch = new DifyKnowledgeSearch({
                            apiKey: DIFY_CONFIG.apiKey
                        });
                        console.log('âœ… Knowledge Baseæ¤œç´¢æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.warn('âš ï¸ Knowledge Baseæ¤œç´¢æ©Ÿèƒ½ã®åˆæœŸåŒ–ã«å¤±æ•—:', error);
                }
            }

            initializeEventListeners() {
                this.messageInput.addEventListener('input', () => {
                    const length = this.messageInput.value.length;
                    this.charCount.textContent = length;
                    this.sendButton.disabled = length === 0;
                });

                // æ—¥æœ¬èªå…¥åŠ›å¯¾å¿œ: compositionstart/end ã§å…¥åŠ›çŠ¶æ…‹ã‚’è¿½è·¡
                let isComposing = false;
                const compositionStatus = document.getElementById('compositionStatus');
                
                this.messageInput.addEventListener('compositionstart', () => {
                    isComposing = true;
                    compositionStatus.textContent = '[å¤‰æ›ä¸­]';
                });
                
                this.messageInput.addEventListener('compositionend', () => {
                    isComposing = false;
                    compositionStatus.textContent = '';
                });

                this.messageInput.addEventListener('keydown', (e) => {
                    // æ—¥æœ¬èªå…¥åŠ›ä¸­ï¼ˆå¤‰æ›ä¸­ï¼‰ã¯é€ä¿¡ã‚’ç„¡åŠ¹åŒ–
                    if (isComposing) {
                        return;
                    }
                    
                    if (e.key === 'Enter') {
                        if (e.shiftKey) {
                            // Shift+Enter: æ”¹è¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’è¨±å¯ï¼‰
                            return;
                        } else {
                            // Enterå˜ä½“: é€ä¿¡
                            e.preventDefault();
                            if (!this.sendButton.disabled) {
                                this.sendMessage();
                            }
                        }
                    }
                });

                this.sendButton.addEventListener('click', () => this.sendMessage());

                this.quickActions.forEach(button => {
                    button.addEventListener('click', () => {
                        const message = button.getAttribute('data-message');
                        this.messageInput.value = message;
                        this.messageInput.dispatchEvent(new Event('input'));
                        this.messageInput.focus();
                    });
                });

                this.messageInput.focus();
            }

            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;

                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
                if (typeof feedbackSystem !== 'undefined') {
                    feedbackSystem.recordSearchQuery(message, 'chat');
                }

                this.addMessage('user', message);
                this.messageInput.value = '';
                this.messageInput.dispatchEvent(new Event('input'));

                this.sendButton.disabled = true;
                this.sendButton.textContent = 'é€ä¿¡ä¸­...';

                const typingIndicator = this.addTypingIndicator();

                try {
                    // Knowledge Baseæ¤œç´¢ã¨ãƒãƒ£ãƒƒãƒˆå¿œç­”ã‚’ä¸¦åˆ—å®Ÿè¡Œ
                    const [knowledgeResult, chatResponse] = await Promise.allSettled([
                        this.searchKnowledgeBase(message),
                        this.difyClient.sendMessage(message)
                    ]);

                    typingIndicator.remove();

                    // çµ±åˆå¿œç­”ã‚’ç”Ÿæˆ
                    const integratedResponse = this.integrateResponses(
                        message,
                        knowledgeResult.status === 'fulfilled' ? knowledgeResult.value : null,
                        chatResponse.status === 'fulfilled' ? chatResponse.value : null
                    );

                    this.addMessage('ai', integratedResponse);

                } catch (error) {
                    console.error('Failed to send message:', error);
                    typingIndicator.remove();
                    this.addMessage('ai', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                } finally {
                    this.sendButton.disabled = false;
                    this.sendButton.textContent = 'é€ä¿¡';
                }
            }

            async searchKnowledgeBase(query) {
                if (!this.knowledgeSearch) {
                    return null;
                }

                try {
                    console.log('ğŸ” Knowledge Baseæ¤œç´¢å®Ÿè¡Œ:', query);
                    const result = await this.knowledgeSearch.searchKnowledge(query);
                    return result;
                } catch (error) {
                    console.warn('Knowledge Baseæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }

            integrateResponses(originalQuery, knowledgeResult, chatResponse) {
                let response = '';

                // ãƒãƒ£ãƒƒãƒˆå¿œç­”ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹
                if (chatResponse && chatResponse.answer) {
                    response = chatResponse.answer;
                }

                // Knowledge Baseæ¤œç´¢çµæœãŒã‚ã‚Œã°çµ±åˆ
                if (knowledgeResult && knowledgeResult.success && knowledgeResult.answer) {
                    // ç¤¾å†…ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ã€ãã‚Œã‚’å„ªå…ˆã—ã¦è¡¨ç¤º
                    if (!knowledgeResult.answer.includes('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ') && 
                        !knowledgeResult.answer.includes('ç¤¾å†…ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“')) {
                        
                        response = `ğŸ“Š **ç¤¾å†…ãƒ‡ãƒ¼ã‚¿æ¤œç´¢çµæœ:**\n\n${knowledgeResult.answer}\n\n---\n\nğŸ’¡ **AIåˆ†æ:**\n\n${response}`;
                    }
                }

                return response || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            }

            addMessage(sender, text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message flex items-start space-x-3';
                const timestamp = new Date().toLocaleString('ja-JP');
                
                if (sender === 'user') {
                    messageDiv.innerHTML = `
                        <div class="bg-gray-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                            You
                        </div>
                        <div class="bg-gray-100 rounded-lg px-4 py-3 max-w-md">
                            <p class="text-gray-800 whitespace-pre-wrap">${this.escapeHtml(text)}</p>
                            <p class="text-xs text-gray-500 mt-2">${timestamp}</p>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                            AI
                        </div>
                        <div class="bg-blue-50 rounded-lg px-4 py-3 max-w-md">
                            <div class="text-gray-800 whitespace-pre-wrap">${this.formatAIResponse(text)}</div>
                            <p class="text-xs text-gray-500 mt-2">${timestamp}</p>
                        </div>
                    `;
                }

                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                
                // å±¥æ­´ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ä¿å­˜ï¼ˆåˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é™¤å¤–ï¼‰
                if (!text.includes('ã“ã‚“ã«ã¡ã¯ï¼ãƒ•ãƒ­ãƒ³ãƒˆã‚ªãƒ•ã‚£ã‚¹æ¥­å‹™ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹')) {
                    this.saveChatMessage(sender === 'user' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' : 'AI', text, timestamp);
                    
                    // ä¼šè©±ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ã‚‚ä¿å­˜
                    if (window.conversationManager) {
                        window.conversationManager.addMessageToCurrentConversation(sender, text);
                    }
                }
            }
            
            saveChatMessage(sender, content, timestamp) {
                const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                history.push({
                    timestamp: timestamp,
                    sender: sender,
                    content: content
                });
                localStorage.setItem('chatHistory', JSON.stringify(history));
            }

            loadChatHistory() {
                const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                
                // æ—¢å­˜ã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¾Œã«å±¥æ­´ã‚’å¾©å…ƒ
                if (history.length > 0) {
                    console.log(`ğŸ’¾ ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å¾©å…ƒä¸­... ${history.length}ä»¶`);
                    
                    history.forEach(item => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message flex items-start space-x-3';
                        
                        if (item.sender === 'ãƒ¦ãƒ¼ã‚¶ãƒ¼') {
                            messageDiv.innerHTML = `
                                <div class="bg-gray-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                    You
                                </div>
                                <div class="bg-gray-100 rounded-lg px-4 py-3 max-w-md">
                                    <p class="text-gray-800 whitespace-pre-wrap">${this.escapeHtml(item.content)}</p>
                                    <p class="text-xs text-gray-500 mt-2">${item.timestamp}</p>
                                </div>
                            `;
                        } else {
                            messageDiv.innerHTML = `
                                <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                    AI
                                </div>
                                <div class="bg-blue-50 rounded-lg px-4 py-3 max-w-md">
                                    <div class="text-gray-800 whitespace-pre-wrap">${this.formatAIResponse(item.content)}</div>
                                    <p class="text-xs text-gray-500 mt-2">${item.timestamp}</p>
                                </div>
                            `;
                        }
                        
                        this.chatMessages.appendChild(messageDiv);
                    });
                    
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                    console.log('âœ… ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸ');
                }
            }

            addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message flex items-start space-x-3 typing-indicator';
                typingDiv.innerHTML = `
                    <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                        AI
                    </div>
                    <div class="bg-blue-50 rounded-lg px-4 py-3">
                        <div class="flex space-x-2">
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                `;
                this.chatMessages.appendChild(typingDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                return typingDiv;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatAIResponse(text) {
                return text
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>')
                    .replace(/â€¢ /g, 'â€¢ ');
            }
        }

        // å³åº§ã«åˆæœŸåŒ–ï¼ˆDOMContentLoadedã‚’å¾…ãŸãªã„ï¼‰
        function initializeDify() {
            console.log('ğŸš€ Dify Chat v2.0 åˆæœŸåŒ–é–‹å§‹...');
            console.log('ğŸ“¡ APIè¨­å®šç¢ºèª:', DIFY_CONFIG);
            console.log('ğŸ”‘ APIã‚­ãƒ¼ç¢ºèª:', DIFY_CONFIG.apiKey ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š');
            console.log('ğŸŒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:', DIFY_CONFIG.apiEndpoint);
            
            const difyClient = new DifyClient(DIFY_CONFIG);
            const chatUI = new ChatUIManager(difyClient);
            window.difyChat = { client: difyClient, ui: chatUI };
            
            console.log('âœ… Dify ChatåˆæœŸåŒ–å®Œäº†ï¼');
            console.log('ğŸ¯ window.difyChat:', window.difyChat);
        }

        // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰åˆæœŸåŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeDify();
                // ConversationManagerã‚’åˆæœŸåŒ–
                window.conversationManager = new ConversationManager();
                window.conversationManager.migrateOldHistory();
            });
        } else {
            initializeDify();
            // ConversationManagerã‚’åˆæœŸåŒ–
            window.conversationManager = new ConversationManager();
            window.conversationManager.migrateOldHistory();
        }
    </script>
    
    <script>
        // Dify APIãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
        setTimeout(() => {
            if (typeof window.difyChat !== 'undefined') {
                console.log('âœ… Dify Chatæ­£å¸¸å‹•ä½œä¸­');
            } else {
                console.error('âŒ Dify ChatåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }, 1000);
    </script>
</body>
</html>