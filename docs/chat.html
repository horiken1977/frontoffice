<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>チャット入力 - フロントオフィス生産性向上アプリ v2.1</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container {
            height: calc(100vh - 120px);
        }
        .sidebar {
            width: 280px;
            min-width: 280px;
            transition: transform 0.3s ease;
        }
        .sidebar.hidden {
            transform: translateX(-100%);
        }
        .chat-main {
            flex: 1;
            min-width: 0;
        }
        .conversation-item {
            transition: background-color 0.2s ease, border-left 0.2s ease;
            cursor: pointer;
        }
        .conversation-item:hover {
            background-color: #f3f4f6;
        }
        .conversation-item.active {
            background-color: #dbeafe;
            border-left: 3px solid #3b82f6;
        }
        .sidebar-toggle {
            position: fixed;
            top: 120px;
            left: 10px;
            z-index: 1000;
            transition: left 0.3s ease;
        }
        .sidebar-toggle.sidebar-open {
            left: 290px;
        }
        .message {
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 999;
                background: white;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            .sidebar-toggle.sidebar-open {
                left: 10px;
            }
        }
        .send-button:hover {
            transform: scale(1.05);
        }
        .send-button {
            transition: all 0.2s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- サイドバートグルボタン -->
    <button id="sidebarToggle" class="sidebar-toggle bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full shadow-lg">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <div class="flex h-screen bg-gray-50">
        <!-- サイドバー -->
        <div id="sidebar" class="sidebar bg-white border-r border-gray-200 flex flex-col">
            <!-- サイドバーヘッダー -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800">チャット履歴</h2>
                    <button id="newChatBtn" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">過去の会話から選択</p>
            </div>

            <!-- 会話リスト -->
            <div id="conversationList" class="flex-1 overflow-y-auto p-2">
                <!-- 会話アイテムがここに動的に追加される -->
            </div>

            <!-- サイドバーフッター -->
            <div class="p-4 border-t border-gray-200">
                <div class="space-y-2">
                    <button onclick="exportAllConversations()" class="w-full bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        📊 全履歴エクスポート
                    </button>
                    <button onclick="clearAllConversations()" class="w-full bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        🗑️ 全履歴削除
                    </button>
                </div>
            </div>
        </div>

        <!-- メインチャットエリア -->
        <div class="chat-main flex flex-col">
            <!-- ナビゲーション -->
            <nav class="bg-white shadow-sm border-b">
                <div class="container mx-auto px-4 py-3">
                    <div class="flex items-center justify-between">
                        <h1 class="text-xl font-bold text-gray-800">フロントオフィス生産性向上アプリ</h1>
                        <div class="space-x-4">
                            <a href="index.html" class="text-blue-600 hover:text-blue-800 font-medium">進捗ダッシュボード</a>
                            <a href="plan.html" class="text-blue-600 hover:text-blue-800 font-medium">開発計画書</a>
                            <a href="chat.html" class="text-gray-800 font-medium border-b-2 border-blue-600">チャット入力</a>
                            <a href="data-search.html" class="text-blue-600 hover:text-blue-800 font-medium">社内データ検索</a>
                            <a href="ai-agent-research.html" class="text-blue-600 hover:text-blue-800 font-medium">AI調査レポート</a>
                            <a href="feedback-dashboard.html" class="text-blue-600 hover:text-blue-800 font-medium">フィードバック</a>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="flex-1 flex flex-col">
                <!-- チャットヘッダー -->
                <div class="p-4 border-b border-gray-200 bg-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 id="chatTitle" class="text-xl font-bold text-gray-800">新しいチャット</h1>
                            <p class="text-sm text-gray-500">営業・マーケティング業務をサポートします</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="sendFeedback()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                                💬 GitHubフィードバック
                            </button>
                            <a href="feedback-dashboard.html" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                                📊 フィードバック管理
                            </a>
                        </div>
                    </div>
                </div>

                <!-- クイックアクション -->
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <p class="text-sm text-gray-600 mb-3">💡 よく使われる機能:</p>
                    <div class="flex flex-wrap gap-2 mb-3">
                    <button class="quick-action bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="新規顧客への提案書を作成したいです">
                        📝 提案書作成
                    </button>
                    <button class="quick-action bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="既存顧客の課題分析をお願いします">
                        📊 顧客分析
                    </button>
                    <button class="quick-action bg-orange-100 hover:bg-orange-200 text-orange-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="見積もりを作成してください">
                        💰 見積作成
                    </button>
                    <button class="quick-action bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="ターゲットペルソナを作成したいです">
                        👥 ペルソナ作成
                    </button>
                    <button class="quick-action bg-pink-100 hover:bg-pink-200 text-pink-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="競合分析を実施してください">
                        🎯 競合分析
                    </button>
                    <button class="quick-action bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-message="顧客情報テンプレート">
                        📋 顧客情報テンプレート
                    </button>
                    </div>
                </div>

                <!-- チャット画面 -->
                <div class="flex-1 flex flex-col bg-white">
                    <!-- チャット履歴エリア -->
                    <div id="chatMessages" class="flex-1 p-6 overflow-y-auto space-y-4">
                <!-- 初期メッセージ -->
                <div class="message flex items-start space-x-3">
                    <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                        AI
                    </div>
                    <div class="bg-blue-50 rounded-lg px-4 py-3 max-w-md">
                        <p class="text-gray-800">こんにちは！フロントオフィス業務をサポートするAIアシスタントです。</p>
                        <p class="text-gray-800 mt-2">以下のような業務をお手伝いできます：</p>
                        <ul class="list-disc list-inside text-gray-700 mt-2 text-sm space-y-1">
                            <li>営業提案の作成</li>
                            <li>顧客分析</li>
                            <li>見積もり作成</li>
                            <li>マーケティング戦略立案</li>
                            <li>ペルソナ作成・分析</li>
                        </ul>
                        <p class="text-gray-800 mt-2">何かお手伝いできることはありますか？</p>
                    </div>
                </div>
                    </div>

                    <!-- 入力エリア -->
                    <div class="border-t bg-gray-50 p-4">
                <div class="flex items-end space-x-3">
                    <div class="flex-1">
                        <textarea 
                            id="messageInput" 
                            placeholder="メッセージを入力してください... (Enter: 送信 / Shift+Enter: 改行)"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            rows="5"
                            maxlength="5000"
                        ></textarea>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-400">💡 Enter: 送信 / Shift+Enter: 改行 <span id="compositionStatus" class="text-red-500"></span></span>
                                <button onclick="saveDraft()" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-2 py-1 rounded text-xs transition-colors">
                                    💾 下書き保存
                                </button>
                                <button onclick="loadDraft()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-xs transition-colors" id="loadDraftBtn" style="display: none;">
                                    📄 下書き読込
                                </button>
                                <button onclick="clearDraft()" class="bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded text-xs transition-colors" id="clearDraftBtn" style="display: none;">
                                    🗑️ 下書き削除
                                </button>
                            </div>
                            <span><span id="charCount">0</span>/5000文字</span>
                        </div>
                    </div>
                    <button 
                        id="sendButton"
                        class="send-button bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
                        disabled
                    >
                        送信
                    </button>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

        <script>
            // 会話管理システム
            class ConversationManager {
                constructor() {
                    this.conversations = this.loadConversations();
                    this.currentConversationId = null;
                    this.isNewConversation = true;
                    this.initializeUI();
                }

                loadConversations() {
                    return JSON.parse(localStorage.getItem('conversations') || '[]');
                }

                saveConversations() {
                    localStorage.setItem('conversations', JSON.stringify(this.conversations));
                }

                createNewConversation(firstMessage = null) {
                    const conversation = {
                        id: Date.now().toString(),
                        title: firstMessage ? this.generateTitle(firstMessage) : '新しいチャット',
                        messages: [],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    this.conversations.unshift(conversation);
                    this.saveConversations();
                    this.currentConversationId = conversation.id;
                    this.isNewConversation = false;
                    
                    this.updateUI();
                    this.updateChatTitle(conversation.title);
                    
                    return conversation;
                }

                generateTitle(message) {
                    // メッセージから適切なタイトルを生成
                    const words = message.trim().split(/\s+/);
                    if (words.length <= 4) {
                        return message;
                    }
                    return words.slice(0, 4).join(' ') + '...';
                }

                addMessageToCurrentConversation(sender, content) {
                    if (this.isNewConversation && sender === 'user') {
                        this.createNewConversation(content);
                    }
                    
                    if (!this.currentConversationId) return;
                    
                    const conversation = this.conversations.find(c => c.id === this.currentConversationId);
                    if (conversation) {
                        conversation.messages.push({
                            id: Date.now().toString(),
                            sender: sender,
                            content: content,
                            timestamp: new Date().toISOString()
                        });
                        conversation.updatedAt = new Date().toISOString();
                        
                        // タイトルが「新しいチャット」の場合、最初のメッセージでタイトルを更新
                        if (conversation.title === '新しいチャット' && sender === 'user') {
                            conversation.title = this.generateTitle(content);
                            this.updateChatTitle(conversation.title);
                        }
                        
                        this.saveConversations();
                        this.updateUI();
                    }
                }

                loadConversation(conversationId) {
                    const conversation = this.conversations.find(c => c.id === conversationId);
                    if (!conversation) return;
                    
                    this.currentConversationId = conversationId;
                    this.isNewConversation = false;
                    
                    // チャット画面をクリア
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    // 初期メッセージを追加
                    this.addInitialMessage();
                    
                    // 会話のメッセージを復元
                    conversation.messages.forEach(msg => {
                        this.addMessageToUI(msg.sender, msg.content);
                    });
                    
                    this.updateChatTitle(conversation.title);
                    this.updateUI();
                    
                    // チャット画面をスクロール
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                displayMessage(sender, content, save = true) {
                    // UIに表示
                    this.addMessageToUI(sender, content);
                    
                    // 会話に保存
                    if (save) {
                        this.addMessageToCurrentConversation(sender, content);
                    }
                }
                
                addMessageToUI(sender, content) {
                    const chatMessages = document.getElementById('chatMessages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message flex items-start space-x-3';
                    
                    if (sender === 'user') {
                        messageDiv.innerHTML = `
                            <div class="bg-gray-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                U
                            </div>
                            <div class="bg-gray-100 rounded-lg px-4 py-3 max-w-md">
                                <p class="text-gray-800 whitespace-pre-wrap">${content}</p>
                            </div>
                        `;
                    } else {
                        messageDiv.innerHTML = `
                            <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                AI
                            </div>
                            <div class="bg-blue-50 rounded-lg px-4 py-3 max-w-md">
                                <p class="text-gray-800 whitespace-pre-wrap">${content}</p>
                            </div>
                        `;
                    }
                    
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                addInitialMessage() {
                    const chatMessages = document.getElementById('chatMessages');
                    const initialMessage = document.createElement('div');
                    initialMessage.className = 'message flex items-start space-x-3';
                    initialMessage.innerHTML = `
                        <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                            AI
                        </div>
                        <div class="bg-blue-50 rounded-lg px-4 py-3 max-w-md">
                            <p class="text-gray-800">こんにちは！フロントオフィス業務をサポートするAIアシスタントです。</p>
                            <p class="text-gray-800 mt-2">以下のような業務をお手伝いできます：</p>
                            <ul class="list-disc list-inside text-gray-700 mt-2 text-sm space-y-1">
                                <li>営業提案の作成</li>
                                <li>顧客分析</li>
                                <li>見積もり作成</li>
                                <li>マーケティング戦略立案</li>
                                <li>ペルソナ作成・分析</li>
                            </ul>
                            <p class="text-gray-800 mt-2">何かお手伝いできることはありますか？</p>
                        </div>
                    `;
                    chatMessages.appendChild(initialMessage);
                }

                startNewConversation() {
                    this.currentConversationId = null;
                    this.isNewConversation = true;
                    
                    // チャット画面をクリア
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    // 初期メッセージを追加
                    this.addInitialMessage();
                    
                    this.updateChatTitle('新しいチャット');
                    this.updateUI();
                }

                deleteConversation(conversationId) {
                    this.conversations = this.conversations.filter(c => c.id !== conversationId);
                    this.saveConversations();
                    
                    if (this.currentConversationId === conversationId) {
                        this.startNewConversation();
                    }
                    
                    this.updateUI();
                }

                updateUI() {
                    const conversationList = document.getElementById('conversationList');
                    if (!conversationList) return;
                    
                    conversationList.innerHTML = '';
                    
                    if (this.conversations.length === 0) {
                        conversationList.innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <p class="text-sm">まだ会話がありません</p>
                                <p class="text-xs mt-1">新しいチャットを開始してみてください</p>
                            </div>
                        `;
                        return;
                    }
                    
                    this.conversations.forEach(conversation => {
                        const item = document.createElement('div');
                        item.className = `conversation-item p-3 mb-2 rounded-lg cursor-pointer ${
                            conversation.id === this.currentConversationId ? 'active' : ''
                        }`;
                        
                        const lastMessage = conversation.messages[conversation.messages.length - 1];
                        const preview = lastMessage ? 
                            (lastMessage.content.length > 50 ? lastMessage.content.substring(0, 50) + '...' : lastMessage.content) : 
                            '空の会話';
                        
                        item.innerHTML = `
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-sm font-medium text-gray-800 truncate">${conversation.title}</h4>
                                    <p class="text-xs text-gray-500 mt-1 truncate">${preview}</p>
                                    <p class="text-xs text-gray-400 mt-1">${this.formatDate(conversation.updatedAt)}</p>
                                </div>
                                <button onclick="conversationManager.deleteConversation('${conversation.id}')" 
                                        class="ml-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        `;
                        
                        item.addEventListener('click', (e) => {
                            if (e.target.closest('button')) return; // 削除ボタンクリックは無視
                            this.loadConversation(conversation.id);
                        });
                        
                        conversationList.appendChild(item);
                    });
                }

                formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
                    
                    if (diffInHours < 1) return '今';
                    if (diffInHours < 24) return `${diffInHours}時間前`;
                    if (diffInHours < 168) return `${Math.floor(diffInHours / 24)}日前`;
                    return date.toLocaleDateString('ja-JP');
                }

                updateChatTitle(title) {
                    const chatTitle = document.getElementById('chatTitle');
                    if (chatTitle) {
                        chatTitle.textContent = title;
                    }
                }

                initializeUI() {
                    // サイドバートグル
                    const toggleBtn = document.getElementById('sidebarToggle');
                    const sidebar = document.getElementById('sidebar');
                    
                    if (toggleBtn && sidebar) {
                        toggleBtn.addEventListener('click', () => {
                            sidebar.classList.toggle('hidden');
                            toggleBtn.classList.toggle('sidebar-open');
                        });
                    }
                    
                    // 新しいチャットボタン
                    const newChatBtn = document.getElementById('newChatBtn');
                    if (newChatBtn) {
                        newChatBtn.addEventListener('click', () => {
                            this.startNewConversation();
                        });
                    }
                    
                    this.updateUI();
                }

                // 既存の履歴をマイグレーション
                migrateOldHistory() {
                    const oldHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                    if (oldHistory.length > 0 && this.conversations.length === 0) {
                        const conversation = {
                            id: 'migrated-' + Date.now(),
                            title: '以前のチャット履歴',
                            messages: oldHistory.map(msg => ({
                                id: Date.now().toString() + Math.random(),
                                sender: msg.sender === 'ユーザー' ? 'user' : 'ai',
                                content: msg.content,
                                timestamp: msg.timestamp || new Date().toISOString()
                            })),
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        this.conversations.push(conversation);
                        this.saveConversations();
                        
                        // 古い履歴を削除
                        localStorage.removeItem('chatHistory');
                    }
                }
            }

            // グローバル変数として初期化
            let conversationManager;

            // エクスポート関数を更新
            function exportAllConversations() {
                const conversations = conversationManager.conversations;
                if (conversations.length === 0) {
                    alert('エクスポートする会話がありません');
                    return;
                }
                
                let csvContent = '\uFEFF'; // BOM for UTF-8
                csvContent += '会話ID,会話タイトル,日時,発信者,内容\n';
                
                conversations.forEach(conv => {
                    conv.messages.forEach(msg => {
                        const csvRow = [
                            `"${conv.id}"`,
                            `"${conv.title}"`,
                            `"${msg.timestamp}"`,
                            `"${msg.sender === 'user' ? 'ユーザー' : 'AI'}"`,
                            `"${msg.content.replace(/"/g, '""').replace(/\n/g, ' ')}"`
                        ].join(',');
                        csvContent += csvRow + '\n';
                    });
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `all_conversations_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`全ての会話履歴をエクスポートしました\n会話数: ${conversations.length}件`);
            }

            function clearAllConversations() {
                const conversations = conversationManager.conversations;
                if (conversations.length === 0) {
                    alert('削除する会話がありません');
                    return;
                }
                
                if (confirm(`全ての会話履歴を削除しますか？\n\n会話数: ${conversations.length}件\nこの操作は取り消せません。`)) {
                    conversationManager.conversations = [];
                    conversationManager.saveConversations();
                    conversationManager.startNewConversation();
                    alert(`全ての会話履歴を削除しました\n削除数: ${conversations.length}件`);
                }
            }

            function testDifyConnection() {
                console.log('=== Dify接続テスト開始 ===');
                console.log('DIFY_CONFIG:', typeof DIFY_CONFIG !== 'undefined' ? DIFY_CONFIG : '未定義');
                console.log('window.difyChat:', typeof window.difyChat !== 'undefined' ? 'あり' : '未定義');
                
                if (typeof window.difyChat !== 'undefined') {
                    window.difyChat.client.sendMessage('テスト').then(response => {
                        console.log('✅ API接続成功:', response);
                        alert('API接続成功！');
                    }).catch(error => {
                        console.error('❌ API接続失敗:', error);
                        alert('API接続失敗: ' + error.message);
                    });
                } else {
                    alert('Dify Chatが初期化されていません');
                }
            }

            function sendFeedback() {
                // フィードバック送信フォームを表示
                const feedbackModal = createFeedbackModal();
                document.body.appendChild(feedbackModal);
            }

            function createFeedbackModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">📝 フィードバック送信</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">カテゴリ</label>
                            <select id="feedbackCategory" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">カテゴリを選択...</option>
                                <option value="ui">画面・操作性</option>
                                <option value="feature">新機能要望</option>
                                <option value="bug">不具合報告</option>
                                <option value="search">検索機能</option>
                                <option value="chat">チャット機能</option>
                                <option value="other">その他</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">フィードバック内容</label>
                            <textarea id="feedbackContent" rows="4" class="w-full px-3 py-2 border rounded-lg" placeholder="具体的な内容をお聞かせください..."></textarea>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="submitFeedback()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                                送信
                            </button>
                            <button onclick="closeFeedbackModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                                キャンセル
                            </button>
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-500">
                            フィードバックは管理画面で確認できます。GitHubの課題としても作成されます。
                        </div>
                    </div>
                `;
                return modal;
            }

            function submitFeedback() {
                const category = document.getElementById('feedbackCategory').value;
                const content = document.getElementById('feedbackContent').value.trim();
                
                if (!category || !content) {
                    alert('カテゴリと内容を入力してください。');
                    return;
                }
                
                // フィードバックシステムに記録
                if (typeof feedbackSystem !== 'undefined') {
                    feedbackSystem.submitImprovement(category, content, 'chat');
                    
                    // 成功メッセージ
                    alert('フィードバックを送信しました！\n\n管理画面（フィードバック）でご確認いただけます。\nありがとうございます！');
                    
                    // GitHubにも送信（オプション）
                    openGitHubIssue(category, content);
                } else {
                    alert('フィードバックシステムが利用できません。');
                }
                
                closeFeedbackModal();
            }

            function openGitHubIssue(category, content) {
                const categoryLabels = {
                    'ui': '画面・操作性',
                    'feature': '新機能要望', 
                    'bug': '不具合報告',
                    'search': '検索機能',
                    'chat': 'チャット機能',
                    'other': 'その他'
                };
                
                const title = `[${categoryLabels[category]}] フィードバック`;
                const body = `## フィードバック内容\n\n${content}\n\n## 送信情報\n- ページ: チャット画面\n- 日時: ${new Date().toLocaleString('ja-JP')}\n- ブラウザ: ${navigator.userAgent}`;
                
                const githubUrl = `https://github.com/horiken1977/frontoffice/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;
                window.open(githubUrl, '_blank');
            }

            function closeFeedbackModal() {
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) {
                    modal.remove();
                }
            }

            // 下書き保存機能
            function saveDraft() {
                const messageInput = document.getElementById('messageInput');
                const content = messageInput.value.trim();
                
                if (content.length === 0) {
                    alert('保存する内容がありません');
                    return;
                }
                
                // ローカルストレージに保存
                const timestamp = new Date().toLocaleString('ja-JP');
                const draftData = {
                    content: content,
                    timestamp: timestamp,
                    charCount: content.length
                };
                
                localStorage.setItem('chatDraft', JSON.stringify(draftData));
                
                // ボタンの表示状態を更新
                updateDraftButtons();
                
                // 保存完了の通知
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '✅ 保存完了';
                button.style.backgroundColor = '#dcfce7';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = '';
                }, 2000);
            }

            // 下書き読み込み機能
            function loadDraft() {
                const draftData = JSON.parse(localStorage.getItem('chatDraft'));
                if (!draftData) {
                    alert('保存された下書きがありません');
                    return;
                }
                
                const messageInput = document.getElementById('messageInput');
                const confirmMessage = `下書きを読み込みますか？\n\n保存日時: ${draftData.timestamp}\n文字数: ${draftData.charCount}文字\n\n現在の入力内容は上書きされます。`;
                
                if (confirm(confirmMessage)) {
                    messageInput.value = draftData.content;
                    messageInput.dispatchEvent(new Event('input'));
                    messageInput.focus();
                    
                    // 読み込み完了の通知
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = '✅ 読込完了';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                }
            }

            // 下書き削除機能
            function clearDraft() {
                const draftData = JSON.parse(localStorage.getItem('chatDraft'));
                if (!draftData) {
                    alert('削除する下書きがありません');
                    return;
                }
                
                if (confirm(`下書きを削除しますか？\n\n保存日時: ${draftData.timestamp}\n文字数: ${draftData.charCount}文字\n\nこの操作は取り消せません。`)) {
                    localStorage.removeItem('chatDraft');
                    updateDraftButtons();
                    
                    // 削除完了の通知
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = '✅ 削除完了';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        updateDraftButtons();
                    }, 2000);
                }
            }

            // 下書きボタンの表示状態を更新
            function updateDraftButtons() {
                const loadBtn = document.getElementById('loadDraftBtn');
                const clearBtn = document.getElementById('clearDraftBtn');
                const hasDraft = localStorage.getItem('chatDraft') !== null;
                
                loadBtn.style.display = hasDraft ? 'inline-block' : 'none';
                clearBtn.style.display = hasDraft ? 'inline-block' : 'none';
            }

            // 自動保存機能（1分ごと）
            function setupAutoSave() {
                const messageInput = document.getElementById('messageInput');
                let autoSaveInterval;

                messageInput.addEventListener('input', () => {
                    // 既存の自動保存タイマーをクリア
                    clearTimeout(autoSaveInterval);
                    
                    // 入力が止まって30秒後に自動保存
                    autoSaveInterval = setTimeout(() => {
                        const content = messageInput.value.trim();
                        if (content.length > 50) { // 50文字以上の場合のみ自動保存
                            const timestamp = new Date().toLocaleString('ja-JP');
                            const draftData = {
                                content: content,
                                timestamp: timestamp + ' (自動保存)',
                                charCount: content.length
                            };
                            localStorage.setItem('chatDraft', JSON.stringify(draftData));
                            updateDraftButtons();
                            console.log('📝 自動保存完了');
                        }
                    }, 30000); // 30秒
                });
            }

            // 旧式の履歴保存機能は不要（リアルタイム保存に変更済み）

            function exportChatHistory() {
                const history = localStorage.getItem('chatHistory');
                if (!history) {
                    alert('エクスポートする履歴がありません');
                    return;
                }
                
                const parsedHistory = JSON.parse(history);
                if (parsedHistory.length === 0) {
                    alert('エクスポートする履歴がありません');
                    return;
                }
                
                // CSV形式でエクスポート
                let csvContent = '\uFEFF'; // BOM for UTF-8
                csvContent += '日時,発信者,チャット内容\n';
                
                parsedHistory.forEach(item => {
                    const csvRow = [
                        `"${item.timestamp}"`,
                        `"${item.sender}"`,
                        `"${item.content.replace(/"/g, '""').replace(/\n/g, ' ')}"`
                    ].join(',');
                    csvContent += csvRow + '\n';
                });
                
                // ファイルダウンロード
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `chat_history_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`チャット履歴をCSVファイルでダウンロードしました\n件数: ${parsedHistory.length}件`);
            }

            function clearChatHistory() {
                const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                const historyCount = history.length;
                
                if (historyCount === 0) {
                    alert('削除する履歴がありません');
                    return;
                }
                
                if (confirm(`チャット履歴を削除しますか？\n\n件数: ${historyCount}件\nこの操作は取り消せません。`)) {
                    localStorage.removeItem('chatHistory');
                    
                    // 画面からも削除（初期メッセージ以外）
                    const chatMessages = document.getElementById('chatMessages');
                    const messages = chatMessages.querySelectorAll('.message');
                    
                    // 最初のメッセージ（初期メッセージ）以外を削除
                    for (let i = 1; i < messages.length; i++) {
                        messages[i].remove();
                    }
                    
                    alert(`チャット履歴を削除しました\n削除件数: ${historyCount}件`);
                }
            }

            // ページ読み込み時に下書きボタンの状態を更新
            document.addEventListener('DOMContentLoaded', () => {
                updateDraftButtons();
                setupAutoSave();
            });
        </script>
    </div>

    <!-- フィードバックシステム -->
    <script src="feedback-system.js"></script>
    <!-- Dify Knowledge Base統合 -->
    <script src="dify-knowledge-integration.js"></script>
    <!-- Dify API統合スクリプト（インライン版） -->
    <script>
        // Dify API設定
        const DIFY_CONFIG = {
            apiEndpoint: 'https://api.dify.ai/v1/chat-messages',
            apiKey: 'app-Fw2J7gNlmmzuCiQL4MhusG70',
            conversationId: null
        };

        // Difyクライアントクラス
        class DifyClient {
            constructor(config) {
                this.config = config;
                this.conversationId = null;
            }

            async sendMessage(message, user = 'default-user') {
                try {
                    const response = await fetch(this.config.apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            inputs: {},
                            query: message,
                            response_mode: 'blocking',
                            conversation_id: this.conversationId,
                            user: user
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.conversation_id) {
                        this.conversationId = data.conversation_id;
                    }

                    return {
                        answer: data.answer,
                        conversationId: data.conversation_id,
                        messageId: data.message_id
                    };
                } catch (error) {
                    console.error('Dify API Error:', error);
                    return {
                        answer: 'エラーが発生しました。しばらくしてから再度お試しください。',
                        error: true
                    };
                }
            }
        }

        // チャットUIマネージャー
        class ChatUIManager {
            constructor(difyClient) {
                this.difyClient = difyClient;
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.charCount = document.getElementById('charCount');
                this.quickActions = document.querySelectorAll('.quick-action');
                
                // Knowledge Base検索システムを初期化
                this.knowledgeSearch = null;
                this.initializeKnowledgeSearch();
                
                this.initializeEventListeners();
                this.loadChatHistory();
            }

            initializeKnowledgeSearch() {
                try {
                    if (typeof DifyKnowledgeSearch !== 'undefined') {
                        this.knowledgeSearch = new DifyKnowledgeSearch({
                            apiKey: DIFY_CONFIG.apiKey
                        });
                        console.log('✅ Knowledge Base検索機能が有効になりました');
                    }
                } catch (error) {
                    console.warn('⚠️ Knowledge Base検索機能の初期化に失敗:', error);
                }
            }

            initializeEventListeners() {
                this.messageInput.addEventListener('input', () => {
                    const length = this.messageInput.value.length;
                    this.charCount.textContent = length;
                    this.sendButton.disabled = length === 0;
                });

                // 日本語入力対応: compositionstart/end で入力状態を追跡
                let isComposing = false;
                const compositionStatus = document.getElementById('compositionStatus');
                
                this.messageInput.addEventListener('compositionstart', () => {
                    isComposing = true;
                    compositionStatus.textContent = '[変換中]';
                });
                
                this.messageInput.addEventListener('compositionend', () => {
                    isComposing = false;
                    compositionStatus.textContent = '';
                });

                this.messageInput.addEventListener('keydown', (e) => {
                    // 日本語入力中（変換中）は送信を無効化
                    if (isComposing) {
                        return;
                    }
                    
                    if (e.key === 'Enter') {
                        if (e.shiftKey) {
                            // Shift+Enter: 改行（デフォルト動作を許可）
                            return;
                        } else {
                            // Enter単体: 送信
                            e.preventDefault();
                            if (!this.sendButton.disabled) {
                                this.sendMessage();
                            }
                        }
                    }
                });

                this.sendButton.addEventListener('click', () => this.sendMessage());

                this.quickActions.forEach(button => {
                    button.addEventListener('click', () => {
                        const message = button.getAttribute('data-message');
                        this.messageInput.value = message;
                        this.messageInput.dispatchEvent(new Event('input'));
                        this.messageInput.focus();
                    });
                });

                this.messageInput.focus();
            }

            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;

                // フィードバックシステムに記録
                if (typeof feedbackSystem !== 'undefined') {
                    feedbackSystem.recordSearchQuery(message, 'chat');
                }

                this.addMessage('user', message);
                this.messageInput.value = '';
                this.messageInput.dispatchEvent(new Event('input'));

                this.sendButton.disabled = true;
                this.sendButton.textContent = '送信中...';

                const typingIndicator = this.addTypingIndicator();

                try {
                    // Knowledge Base検索とチャット応答を並列実行
                    const [knowledgeResult, chatResponse] = await Promise.allSettled([
                        this.searchKnowledgeBase(message),
                        this.difyClient.sendMessage(message)
                    ]);

                    typingIndicator.remove();

                    // 統合応答を生成
                    const integratedResponse = this.integrateResponses(
                        message,
                        knowledgeResult.status === 'fulfilled' ? knowledgeResult.value : null,
                        chatResponse.status === 'fulfilled' ? chatResponse.value : null
                    );

                    this.addMessage('ai', integratedResponse);

                } catch (error) {
                    console.error('Failed to send message:', error);
                    typingIndicator.remove();
                    this.addMessage('ai', 'エラーが発生しました。もう一度お試しください。');
                } finally {
                    this.sendButton.disabled = false;
                    this.sendButton.textContent = '送信';
                }
            }

            async searchKnowledgeBase(query) {
                if (!this.knowledgeSearch) {
                    return null;
                }

                try {
                    console.log('🔍 Knowledge Base検索実行:', query);
                    const result = await this.knowledgeSearch.searchKnowledge(query);
                    return result;
                } catch (error) {
                    console.warn('Knowledge Base検索エラー:', error);
                    return null;
                }
            }

            integrateResponses(originalQuery, knowledgeResult, chatResponse) {
                let response = '';

                // チャット応答をベースにする
                if (chatResponse && chatResponse.answer) {
                    response = chatResponse.answer;
                }

                // Knowledge Base検索結果があれば統合
                if (knowledgeResult && knowledgeResult.success && knowledgeResult.answer) {
                    // 社内データが見つかった場合は、それを優先して表示
                    if (!knowledgeResult.answer.includes('データが見つかりませんでした') && 
                        !knowledgeResult.answer.includes('社内データベースにアクセスできません')) {
                        
                        response = `📊 **社内データ検索結果:**\n\n${knowledgeResult.answer}\n\n---\n\n💡 **AI分析:**\n\n${response}`;
                    }
                }

                return response || 'エラーが発生しました。もう一度お試しください。';
            }

            addMessage(sender, text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message flex items-start space-x-3';
                const timestamp = new Date().toLocaleString('ja-JP');
                
                if (sender === 'user') {
                    messageDiv.innerHTML = `
                        <div class="bg-gray-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                            You
                        </div>
                        <div class="bg-gray-100 rounded-lg px-4 py-3 max-w-md">
                            <p class="text-gray-800 whitespace-pre-wrap">${this.escapeHtml(text)}</p>
                            <p class="text-xs text-gray-500 mt-2">${timestamp}</p>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                            AI
                        </div>
                        <div class="bg-blue-50 rounded-lg px-4 py-3 max-w-md">
                            <div class="text-gray-800 whitespace-pre-wrap">${this.formatAIResponse(text)}</div>
                            <p class="text-xs text-gray-500 mt-2">${timestamp}</p>
                        </div>
                    `;
                }

                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                
                // 履歴をリアルタイムで保存（初期メッセージは除外）
                if (!text.includes('こんにちは！フロントオフィス業務をサポートする')) {
                    this.saveChatMessage(sender === 'user' ? 'ユーザー' : 'AI', text, timestamp);
                    
                    // 会話マネージャーにも保存
                    if (window.conversationManager) {
                        window.conversationManager.addMessageToCurrentConversation(sender, text);
                    }
                }
            }
            
            saveChatMessage(sender, content, timestamp) {
                const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                history.push({
                    timestamp: timestamp,
                    sender: sender,
                    content: content
                });
                localStorage.setItem('chatHistory', JSON.stringify(history));
            }

            loadChatHistory() {
                const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                
                // 既存の初期メッセージの後に履歴を復元
                if (history.length > 0) {
                    console.log(`💾 チャット履歴を復元中... ${history.length}件`);
                    
                    history.forEach(item => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message flex items-start space-x-3';
                        
                        if (item.sender === 'ユーザー') {
                            messageDiv.innerHTML = `
                                <div class="bg-gray-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                    You
                                </div>
                                <div class="bg-gray-100 rounded-lg px-4 py-3 max-w-md">
                                    <p class="text-gray-800 whitespace-pre-wrap">${this.escapeHtml(item.content)}</p>
                                    <p class="text-xs text-gray-500 mt-2">${item.timestamp}</p>
                                </div>
                            `;
                        } else {
                            messageDiv.innerHTML = `
                                <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                    AI
                                </div>
                                <div class="bg-blue-50 rounded-lg px-4 py-3 max-w-md">
                                    <div class="text-gray-800 whitespace-pre-wrap">${this.formatAIResponse(item.content)}</div>
                                    <p class="text-xs text-gray-500 mt-2">${item.timestamp}</p>
                                </div>
                            `;
                        }
                        
                        this.chatMessages.appendChild(messageDiv);
                    });
                    
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                    console.log('✅ チャット履歴の復元が完了しました');
                }
            }

            addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message flex items-start space-x-3 typing-indicator';
                typingDiv.innerHTML = `
                    <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                        AI
                    </div>
                    <div class="bg-blue-50 rounded-lg px-4 py-3">
                        <div class="flex space-x-2">
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                `;
                this.chatMessages.appendChild(typingDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                return typingDiv;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatAIResponse(text) {
                return text
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>')
                    .replace(/• /g, '• ');
            }
        }

        // 即座に初期化（DOMContentLoadedを待たない）
        function initializeDify() {
            console.log('🚀 Dify Chat v2.0 初期化開始...');
            console.log('📡 API設定確認:', DIFY_CONFIG);
            console.log('🔑 APIキー確認:', DIFY_CONFIG.apiKey ? '設定済み' : '未設定');
            console.log('🌐 エンドポイント:', DIFY_CONFIG.apiEndpoint);
            
            const difyClient = new DifyClient(DIFY_CONFIG);
            const chatUI = new ChatUIManager(difyClient);
            window.difyChat = { client: difyClient, ui: chatUI };
            
            console.log('✅ Dify Chat初期化完了！');
            console.log('🎯 window.difyChat:', window.difyChat);
        }

        // DOMが読み込まれたら初期化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeDify();
                // ConversationManagerを初期化
                window.conversationManager = new ConversationManager();
                window.conversationManager.migrateOldHistory();
            });
        } else {
            initializeDify();
            // ConversationManagerを初期化
            window.conversationManager = new ConversationManager();
            window.conversationManager.migrateOldHistory();
        }
    </script>
    
    <script>
        // Dify APIが正常に初期化されたかチェック
        setTimeout(() => {
            if (typeof window.difyChat !== 'undefined') {
                console.log('✅ Dify Chat正常動作中');
            } else {
                console.error('❌ Dify Chat初期化に失敗しました');
            }
        }, 1000);
    </script>
</body>
</html>