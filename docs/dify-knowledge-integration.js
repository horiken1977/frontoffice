// Dify Knowledge Base Áµ±Âêà„Çπ„ÇØ„É™„Éó„Éà
// Á§æÂÜÖ„Éá„Éº„ÇøÊ§úÁ¥¢Ê©üËÉΩÁî®

class DifyKnowledgeSearch {
    constructor(config) {
        this.config = config;
        this.apiEndpoint = 'https://api.dify.ai/v1/chat-messages';
        this.knowledgeEndpoint = 'https://api.dify.ai/v1/knowledge-bases';
    }

    // Knowledge BaseÊ§úÁ¥¢
    async searchKnowledge(query, knowledgeBaseId = null) {
        try {
            console.log('üîç Knowledge BaseÊ§úÁ¥¢ÈñãÂßã:', query);
            
            // Knowledge Base ID„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅÂ∞ÇÁî®Ê§úÁ¥¢„Çí‰ΩøÁî®
            if (knowledgeBaseId) {
                return await this.searchWithKnowledgeBase(query, knowledgeBaseId);
            }
            
            // ÈÄöÂ∏∏„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÊ§úÁ¥¢ÔºàKnowledge Base„ÅåÁµ±Âêà„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
            const response = await fetch(this.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.config.apiKey}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    inputs: {},
                    query: `‰ª•‰∏ã„ÅÆË≥™Âïè„Å´„Å§„ÅÑ„Å¶„ÄÅÁ§æÂÜÖ„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÈñ¢ÈÄ£ÊÉÖÂ†±„ÇíÊ§úÁ¥¢„Åó„Å¶ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö${query}`,
                    response_mode: 'blocking',
                    conversation_id: null, // Êñ∞„Åó„ÅÑÊ§úÁ¥¢„Çª„ÉÉ„Ç∑„Éß„É≥
                    user: 'knowledge-search'
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();
            console.log('‚úÖ Ê§úÁ¥¢ÊàêÂäü:', data);
            
            return {
                success: true,
                answer: data.answer,
                conversationId: data.conversation_id,
                messageId: data.message_id,
                usage: data.metadata?.usage || null
            };
        } catch (error) {
            console.error('‚ùå Knowledge BaseÊ§úÁ¥¢„Ç®„É©„Éº:', error);
            return {
                success: false,
                error: error.message,
                answer: '„Éá„Éº„ÇøÊ§úÁ¥¢‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
            };
        }
    }

    // Knowledge BaseÂ∞ÇÁî®Ê§úÁ¥¢ÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
    async searchWithKnowledgeBase(query, knowledgeBaseId) {
        try {
            const response = await fetch(`${this.knowledgeEndpoint}/${knowledgeBaseId}/search`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.config.apiKey}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    top_k: 5, // ‰∏ä‰Ωç5‰ª∂„ÅÆÈñ¢ÈÄ£ÊñáÊõ∏„ÇíÂèñÂæó
                    score_threshold: 0.5 // Èñ¢ÈÄ£Â∫¶„ÅÆ„Åó„Åç„ÅÑÂÄ§
                })
            });

            if (!response.ok) {
                throw new Error(`Knowledge Base API Error: ${response.status}`);
            }

            const data = await response.json();
            
            return {
                success: true,
                results: data.documents || [],
                answer: this.formatKnowledgeResults(data.documents),
                usage: data.usage || null
            };
        } catch (error) {
            console.error('‚ùå Knowledge BaseÂ∞ÇÁî®Ê§úÁ¥¢„Ç®„É©„Éº:', error);
            return {
                success: false,
                error: error.message,
                answer: 'Â∞ÇÁî®Ê§úÁ¥¢Ê©üËÉΩ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÈÄöÂ∏∏Ê§úÁ¥¢„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
            };
        }
    }

    // Knowledge BaseÊ§úÁ¥¢ÁµêÊûú„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
    formatKnowledgeResults(documents) {
        if (!documents || documents.length === 0) {
            return 'Èñ¢ÈÄ£„Åô„ÇãÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÊ§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„Å¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
        }

        let formattedResult = 'üìä Á§æÂÜÖ„Éá„Éº„ÇøÊ§úÁ¥¢ÁµêÊûú:\n\n';
        
        documents.forEach((doc, index) => {
            formattedResult += `**${index + 1}. ${doc.title || 'Èñ¢ÈÄ£ÊÉÖÂ†±'}**\n`;
            formattedResult += `${doc.content}\n`;
            if (doc.score) {
                formattedResult += `*Èñ¢ÈÄ£Â∫¶: ${Math.round(doc.score * 100)}%*\n`;
            }
            formattedResult += '\n---\n\n';
        });

        return formattedResult;
    }

    // Ê§úÁ¥¢„ÇØ„Ç®„É™„ÅÆÊúÄÈÅ©Âåñ
    optimizeQuery(originalQuery) {
        // Âñ∂Ê•≠Áî®Ë™û„ÅÆÊã°Âºµ
        const salesTerms = {
            'È°ßÂÆ¢': ['È°ßÂÆ¢', '„ÇØ„É©„Ç§„Ç¢„É≥„Éà', 'ÂÆ¢ÂÖà', 'ÂèñÂºïÂÖà'],
            'ÊèêÊ°à': ['ÊèêÊ°à', '„Éó„É≠„Éù„Éº„Ç∂„É´', '‰ºÅÁîª', '„ÇΩ„É™„É•„Éº„Ç∑„Éß„É≥'],
            'Á´∂Âêà': ['Á´∂Âêà', 'Á´∂Âêà‰ªñÁ§æ', '„É©„Ç§„Éê„É´', '‰ªñÁ§æ'],
            '‰æ°Ê†º': ['‰æ°Ê†º', 'ÊñôÈáë', '„Ç≥„Çπ„Éà', 'Ë≤ªÁî®', '‰∫àÁÆó'],
            'Ê©üËÉΩ': ['Ê©üËÉΩ', '„Éï„Ç£„Éº„ÉÅ„É£„Éº', '‰ªïÊßò', '„Çπ„Éö„ÉÉ„ÇØ']
        };

        let optimizedQuery = originalQuery;
        
        // ÂêåÁæ©Ë™û„ÅÆËøΩÂä†
        Object.keys(salesTerms).forEach(key => {
            if (originalQuery.includes(key)) {
                const synonyms = salesTerms[key].join('„ÄÅ');
                optimizedQuery += ` ÔºàÈñ¢ÈÄ£„Ç≠„Éº„ÉØ„Éº„Éâ: ${synonyms}Ôºâ`;
            }
        });

        return optimizedQuery;
    }

    // Ê§úÁ¥¢Â±•Ê≠¥„ÅÆ‰øùÂ≠ò
    saveSearchHistory(query, results) {
        const history = JSON.parse(localStorage.getItem('knowledgeSearchHistory') || '[]');
        
        history.unshift({
            timestamp: new Date().toISOString(),
            query: query,
            resultCount: results.results?.length || 0,
            success: results.success
        });

        // ÊúÄÊñ∞50‰ª∂„ÅÆ„Åø‰øùÊåÅ
        if (history.length > 50) {
            history.splice(50);
        }

        localStorage.setItem('knowledgeSearchHistory', JSON.stringify(history));
    }

    // Ê§úÁ¥¢Â±•Ê≠¥„ÅÆÂèñÂæó
    getSearchHistory() {
        return JSON.parse(localStorage.getItem('knowledgeSearchHistory') || '[]');
    }

    // ‰∫∫Ê∞óÊ§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆÂèñÂæó
    getPopularKeywords() {
        const history = this.getSearchHistory();
        const keywords = {};
        
        history.forEach(item => {
            if (item.success) {
                const words = item.query.split(/\s+/);
                words.forEach(word => {
                    if (word.length > 1) {
                        keywords[word] = (keywords[word] || 0) + 1;
                    }
                });
            }
        });

        // ‰ΩøÁî®È†ªÂ∫¶È†Ü„Å´„ÇΩ„Éº„Éà
        return Object.entries(keywords)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10)
            .map(([keyword]) => keyword);
    }
}

// Ê§úÁ¥¢UIÁÆ°ÁêÜ„ÇØ„É©„Çπ
class KnowledgeSearchUI {
    constructor(difyKnowledgeSearch) {
        this.knowledgeSearch = difyKnowledgeSearch;
        this.currentSearch = null;
        this.initializeElements();
    }

    initializeElements() {
        this.searchButton = document.getElementById('knowledgeSearchButton');
        this.searchInput = document.getElementById('knowledgeSearchInput');
        this.resultsContainer = document.getElementById('knowledgeSearchResults');
        this.loadingIndicator = document.getElementById('searchLoading');
        
        this.setupEventListeners();
    }

    setupEventListeners() {
        if (this.searchButton) {
            this.searchButton.addEventListener('click', () => this.performSearch());
        }

        if (this.searchInput) {
            this.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.performSearch();
                }
            });
        }

        // „ÇØ„Ç§„ÉÉ„ÇØÊ§úÁ¥¢„Éú„Çø„É≥
        document.querySelectorAll('.knowledge-quick-search').forEach(button => {
            button.addEventListener('click', () => {
                const query = button.getAttribute('data-query');
                this.searchInput.value = query;
                this.performSearch();
            });
        });
    }

    async performSearch() {
        const query = this.searchInput.value.trim();
        if (!query) {
            alert('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }

        this.showLoading();
        
        try {
            const optimizedQuery = this.knowledgeSearch.optimizeQuery(query);
            const results = await this.knowledgeSearch.searchKnowledge(optimizedQuery);
            
            this.displayResults(results, query);
            this.knowledgeSearch.saveSearchHistory(query, results);
            
        } catch (error) {
            console.error('Ê§úÁ¥¢„Ç®„É©„Éº:', error);
            this.displayError('Ê§úÁ¥¢‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        } finally {
            this.hideLoading();
        }
    }

    showLoading() {
        if (this.loadingIndicator) {
            this.loadingIndicator.style.display = 'block';
        }
        if (this.searchButton) {
            this.searchButton.disabled = true;
            this.searchButton.textContent = 'Ê§úÁ¥¢‰∏≠...';
        }
    }

    hideLoading() {
        if (this.loadingIndicator) {
            this.loadingIndicator.style.display = 'none';
        }
        if (this.searchButton) {
            this.searchButton.disabled = false;
            this.searchButton.textContent = 'Ê§úÁ¥¢';
        }
    }

    displayResults(results, originalQuery) {
        if (!this.resultsContainer) return;

        const timestamp = new Date().toLocaleString('ja-JP');
        
        if (results.success) {
            this.resultsContainer.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-gray-800">üîç Ê§úÁ¥¢ÁµêÊûú: "${originalQuery}"</h3>
                        <span class="text-xs text-gray-500">${timestamp}</span>
                    </div>
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                        <div class="prose prose-sm max-w-none">
                            ${this.formatResultContent(results.answer)}
                        </div>
                    </div>
                    ${results.usage ? this.formatUsageInfo(results.usage) : ''}
                </div>
            `;
        } else {
            this.resultsContainer.innerHTML = `
                <div class="space-y-4">
                    <h3 class="font-semibold text-gray-800">üîç Ê§úÁ¥¢ÁµêÊûú: "${originalQuery}"</h3>
                    <div class="bg-red-50 border-l-4 border-red-400 p-4">
                        <p class="text-red-700">${results.answer}</p>
                        <p class="text-xs text-red-600 mt-2">„Ç®„É©„ÉºË©≥Á¥∞: ${results.error}</p>
                    </div>
                </div>
            `;
        }
    }

    displayError(message) {
        if (!this.resultsContainer) return;
        
        this.resultsContainer.innerHTML = `
            <div class="bg-red-50 border-l-4 border-red-400 p-4">
                <p class="text-red-700">${message}</p>
            </div>
        `;
    }

    formatResultContent(content) {
        return content
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>')
            .replace(/---/g, '<hr class="my-2">');
    }

    formatUsageInfo(usage) {
        return `
            <div class="bg-gray-50 border border-gray-200 rounded p-3 text-xs text-gray-600">
                <span class="font-medium">API‰ΩøÁî®Èáè:</span>
                „Éà„Éº„ÇØ„É≥Êï∞: ${usage.total_tokens || 'N/A'} |
                Ê§úÁ¥¢ÊôÇÈñì: ${usage.response_time || 'N/A'}ms
            </div>
        `;
    }
}

// „Ç∞„É≠„Éº„Éê„É´ÂàùÊúüÂåñ
let knowledgeSearchSystem = null;

function initializeKnowledgeSearch(apiKey) {
    if (!apiKey) {
        console.error('‚ùå API Key „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        return;
    }

    const config = { apiKey: apiKey };
    const knowledgeSearch = new DifyKnowledgeSearch(config);
    const searchUI = new KnowledgeSearchUI(knowledgeSearch);
    
    knowledgeSearchSystem = {
        search: knowledgeSearch,
        ui: searchUI
    };
    
    console.log('‚úÖ Knowledge Search System ÂàùÊúüÂåñÂÆå‰∫Ü');
    return knowledgeSearchSystem;
}

// „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÔºàNode.jsÁí∞Â¢ÉÁî®Ôºâ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        DifyKnowledgeSearch,
        KnowledgeSearchUI,
        initializeKnowledgeSearch
    };
}